# DigitalOcean App Platform Specification
# LightClick Studio - PRODUCTION ENVIRONMENT (EXAMPLE/TEMPLATE)
# 
# Deployment: DigitalOcean Container Registry (DOCR)
# Databases: Managed PostgreSQL + Managed Valkey (PROD instances)
#
# INSTRUCTIONS:
# 1. Copy this file to app.yaml: cp app.yaml.example app.yaml
# 2. Replace all TODO placeholders with actual production values
# 3. Never commit app.yaml to git (it contains secrets)

name: lightclick-studio-prod
region: fra  # Frankfurt

# Custom domain configuration
domains:
  - domain: lightclick.studio
    type: PRIMARY
  - domain: www.lightclick.studio
    type: ALIAS

# App-level environment variables (shared across all services)
envs:
  # Database & Redis (SECRETS)
  - key: DATABASE_URL
    value: "TODO_PROD_POSTGRESQL_CONNECTION_STRING"
    type: SECRET
    scope: RUN_TIME
  
  - key: REDIS_URL
    value: "TODO_PROD_VALKEY_CONNECTION_STRING"
    type: SECRET
    scope: RUN_TIME
  
  # JWT Configuration
  - key: JWT_SECRET
    value: "TODO_JWT_SECRET_32_CHARS_MIN"
    type: SECRET
    scope: RUN_TIME
  
  - key: JWT_ALGORITHM
    value: "HS256"
  
  - key: JWT_ACCESS_TOKEN_EXPIRE_MINUTES
    value: "30"
  
  - key: JWT_REFRESH_TOKEN_EXPIRE_DAYS
    value: "30"
  
  # PayPal Configuration - LIVE MODE
  - key: PAYPAL_MODE
    value: "live"
  
  - key: PAYPAL_CLIENT_ID
    value: "TODO_PAYPAL_LIVE_CLIENT_ID"
    type: SECRET
    scope: RUN_TIME
  
  - key: PAYPAL_CLIENT_SECRET
    value: "TODO_PAYPAL_LIVE_CLIENT_SECRET"
    type: SECRET
    scope: RUN_TIME
  
  - key: PAYPAL_WEBHOOK_ID
    value: "TODO_PAYPAL_WEBHOOK_ID"
  
  - key: PAYPAL_PLAN_ID_BASIC_MONTHLY
    value: "TODO_PLAN_ID"
  
  - key: PAYPAL_PLAN_ID_BASIC_YEARLY
    value: "TODO_PLAN_ID"
  
  - key: PAYPAL_PLAN_ID_PRO_MONTHLY
    value: "TODO_PLAN_ID"
  
  - key: PAYPAL_PLAN_ID_PRO_YEARLY
    value: "TODO_PLAN_ID"
  
  # AI Service (Nano Banana/Gemini)
  - key: NANO_BANANA_API_KEY
    value: "TODO_GEMINI_API_KEY"
    type: SECRET
    scope: RUN_TIME
  
  - key: NANO_BANANA_API_URL
    value: "https://generativelanguage.googleapis.com"
  
  - key: IMAGE_GENERATION_MODE
    value: "live"
  
  - key: USE_VERTEX_AI
    value: "false"
  
  # S3/Spaces Configuration
  - key: S3_ENDPOINT
    value: "https://fra1.digitaloceanspaces.com"
  
  - key: S3_PUBLIC_ENDPOINT
    value: "https://fra1.digitaloceanspaces.com"
  
  - key: S3_BUCKET
    value: "TODO_PROD_BUCKET_NAME"
  
  - key: S3_REGION
    value: "us-east-1"
  
  - key: S3_ACCESS_KEY
    value: "TODO_SPACES_ACCESS_KEY"
    type: SECRET
    scope: RUN_TIME
  
  - key: S3_SECRET_KEY
    value: "TODO_SPACES_SECRET_KEY"
    type: SECRET
    scope: RUN_TIME
  
  # SMTP Configuration
  - key: SMTP_HOST
    value: "smtp.gmail.com"
  
  - key: SMTP_PORT
    value: "587"
  
  - key: SMTP_TLS
    value: "True"
  
  - key: SMTP_USER
    value: "TODO_SMTP_USER"
  
  - key: SMTP_PASSWORD
    value: "TODO_SMTP_PASSWORD"
    type: SECRET
    scope: RUN_TIME
  
  - key: SMTP_FROM
    value: "LightClick Studio Support <support@lightclick.studio>"
    
  - key: SUPPORT_EMAIL
    value: "support@lightclick.studio"
  
  # Google OAuth
  - key: GOOGLE_CLIENT_ID
    value: "TODO_GOOGLE_CLIENT_ID"
  
  - key: GOOGLE_CLIENT_SECRET
    value: "TODO_GOOGLE_CLIENT_SECRET"
    type: SECRET
    scope: RUN_TIME
  
  - key: GOOGLE_REDIRECT_URI
    value: "https://lightclick.studio/api/auth/google/callback"
  
  - key: GOOGLE_CLOUD_PROJECT_ID
    value: ""
  
  # General Configuration
  - key: APP_NAME
    value: "LightClick Studio"
  
  - key: LOG_LEVEL
    value: "INFO"

# Services (long-running containers)
services:
  # FastAPI Backend API
  - name: backend
    image:
      registry_type: DOCR
      registry: productsnap-registry
      repository: lightclick-backend
      tag: prod  # PROD TAG
    
    run_command: "sh -c 'uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers ${WEB_CONCURRENCY:-1}'"
    
    http_port: 8000
    
    instance_count: 1
    instance_size_slug: apps-s-1vcpu-0.5gb  # $5/month
    
    routes:
      - path: /api
        preserve_path_prefix: true
      - path: /health
    
    health_check:
      http_path: /health
      initial_delay_seconds: 30
      period_seconds: 10
      timeout_seconds: 5
      success_threshold: 1
      failure_threshold: 3
    
    envs:
      - key: FRONTEND_URL
        value: "${APP_URL}"
      
      - key: BACKEND_URL
        value: "${APP_URL}/api"
      
      - key: WEB_CONCURRENCY
        value: "2"

  # React Frontend
  - name: frontend
    image:
      registry_type: DOCR
      registry: productsnap-registry
      repository: lightclick-frontend
      tag: prod  # PROD TAG
    
    http_port: 80
    
    instance_count: 1
    instance_size_slug: apps-s-1vcpu-0.5gb  # $5/month
    
    routes:
      - path: /
    
    health_check:
      http_path: /
      initial_delay_seconds: 10
      period_seconds: 10
      timeout_seconds: 3
      success_threshold: 1
      failure_threshold: 3
    
    envs:
      - key: VITE_API_URL
        value: "${APP_URL}/api"

# Workers
workers:
  - name: worker
    image:
      registry_type: DOCR
      registry: productsnap-registry
      repository: lightclick-worker
      tag: prod  # PROD TAG
    
    run_command: "python -m app.worker"
    
    instance_count: 1
    instance_size_slug: apps-s-1vcpu-0.5gb  # $5/month
    
    envs:
      - key: FRONTEND_URL
        value: "${APP_URL}"
      
      - key: BACKEND_URL
        value: "${APP_URL}/api"

# Alerts
alerts:
  - rule: DEPLOYMENT_FAILED
  - rule: DOMAIN_FAILED

# Features
features:
  - buildpack-stack=ubuntu-22
